# kubernetes

本文档是kubernetes1.16.1二进制安装的第五篇

### [上一篇 生成配置文件](https://github.com/mytting/kubernetes/blob/master/v1.16.1-C%20%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6.md)

kubernetes的组件都是无状态的，所有集群的状态都存储在etcd集群中

## etcd的目录结构规划

etcd目录结构

软件包解压目录

/usr/local/etcd/src/

ssl证书申请文件

/usr/local/etcd/json

ssl证书文件

/usr/local/etcd/ssl/

可执行文件

/usr/local/etcd/bin/

工作目录

/usr/local/etcd/data/

etcd的目录在生成证书的最后已经全部创建 并且证书文件也全部拷贝完成

## 1 下载etcd二进制包并解压

```
 wget https://github.com/etcd-io/etcd/releases/download/v3.4.1/etcd-v3.4.1-linux-amd64.tar.gz
tar -zxvf etcd-v3.4.1-linux-amd64.tar.gz -C /usr/local/etcd/src/
```

复制可执行文件

```
cp -p /usr/local/etcd/src/etcd-v3.4.1-linux-amd64/etcd /usr/local/etcd/bin/
cp -p /usr/local/etcd/src/etcd-v3.4.1-linux-amd64/etcdctl /usr/local/etcd/bin/
```

软链接可执行文件

```
ln -s /usr/local/etcd/bin/* /usr/bin/
```

将可执行文件拷贝到另外两台节点

```
for host in  master node1 node2; do scp  /usr/local/etcd/bin/* $host:/usr/local/etcd/bin/; done;
```

## 2 设置etcd系统服务文件

在/etc/systemd/system/目录下导入文件etcd.service

master节点：

```
cat << EOF >> /etc/systemd/system/etcd.service
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
# EnvironmentFile=/opt/work/_app/k8s/etcd/cfg/etcd.conf
ExecStart=/usr/local/etcd/bin/etcd  --name=etcd00   --data-dir=/usr/local/etcd/data/  --listen-peer-urls=https://192.168.10.10:2380 --listen-client-urls=https://192.168.10.10:2379,https://127.0.0.1:2379  --advertise-client-urls=https://192.168.10.10:2379  --initial-advertise-peer-urls=https://192.168.10.10:2380  --initial-cluster=etcd00=https://192.168.10.10:2380,etcd01=https://192.168.10.11:2380,etcd02=https://192.168.10.12:2380 --initial-cluster-token=etcd-cluster --initial-cluster-state=new --cert-file=/usr/local/etcd/ssl/etcd.pem --key-file=/usr/local/etcd/ssl/etcd-key.pem --peer-cert-file=/usr/local/etcd/ssl/etcd.pem --peer-key-file=/usr/local/etcd/ssl/etcd-key.pem --trusted-ca-file=/usr/local/etcd/ssl/ca.pem --peer-trusted-ca-file=/usr/local/etcd/ssl/ca.pem
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
```

node1 节点：

```
cat << EOF >> /etc/systemd/system/etcd.service
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
ExecStart=/usr/local/etcd/bin/etcd  --name=etcd01   --data-dir=/usr/local/etcd/data/  --listen-peer-urls=https://192.168.10.11:2380 --listen-client-urls=https://192.168.10.11:2379,https://127.0.0.1:2379  --advertise-client-urls=https://192.168.10.11:2379  --initial-advertise-peer-urls=https://192.168.10.11:2380  --initial-cluster=etcd00=https://192.168.10.10:2380,etcd01=https://192.168.10.11:2380,etcd02=https://192.168.10.12:2380 --initial-cluster-token=etcd-cluster --initial-cluster-state=new --cert-file=/usr/local/etcd/ssl/etcd.pem --key-file=/usr/local/etcd/ssl/etcd-key.pem --peer-cert-file=/usr/local/etcd/ssl/etcd.pem --peer-key-file=/usr/local/etcd/ssl/etcd-key.pem --trusted-ca-file=/usr/local/etcd/ssl/ca.pem --peer-trusted-ca-file=/usr/local/etcd/ssl/ca.pem
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
```

node2 节点

```
cat << EOF >> /etc/systemd/system/etcd.service
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
ExecStart=/usr/local/etcd/bin/etcd  --name=etcd02   --data-dir=/usr/local/etcd/data/  --listen-peer-urls=https://192.168.10.12:2380 --listen-client-urls=https://192.168.10.12:2379,https://127.0.0.1:2379  --advertise-client-urls=https://192.168.10.12:2379  --initial-advertise-peer-urls=https://192.168.10.12:2380  --initial-cluster=etcd00=https://192.168.10.10:2380,etcd01=https://192.168.10.11:2380,etcd02=https://192.168.10.12:2380 --initial-cluster-token=etcd-cluster --initial-cluster-state=new --cert-file=/usr/local/etcd/ssl/etcd.pem --key-file=/usr/local/etcd/ssl/etcd-key.pem --peer-cert-file=/usr/local/etcd/ssl/etcd.pem --peer-key-file=/usr/local/etcd/ssl/etcd-key.pem --trusted-ca-file=/usr/local/etcd/ssl/ca.pem --peer-trusted-ca-file=/usr/local/etcd/ssl/ca.pem
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
```

### 所有节点启动etcd服务并设置为开机自启 

```
systemctl daemon-reload
systemctl enable etcd.service
systemctl restart etcd.service
```

## 检查etcd集群状态

```
etcdctl  --cacert=/usr/local/etcd/ssl/ca.pem --cert=/usr/local/etcd/ssl/etcd.pem --key=/usr/local/etcd/ssl/etcd-key.pem --endpoints="https://192.168.10.10:2379,https://192.168.10.11:2379,https://192.168.10.12:2379" endpoint health
```

输出信息

```
https://192.168.10.10:2379 is healthy: successfully committed proposal: took = 14.100152ms
https://192.168.10.12:2379 is healthy: successfully committed proposal: took = 29.074303ms
https://192.168.10.11:2379 is healthy: successfully committed proposal: took = 23.022919ms
```

全部节点为healthy 表明etcd集群搭建成功



### [下一篇 部署master组件](https://github.com/mytting/kubernetes/blob/master/v1.16.1-F%20%E9%83%A8%E7%BD%B2master%E7%BB%84%E4%BB%B6.md)