# kubernetes

##  配置和生成kubernetes配置文件

本文档是kubernetes1.16.1二进制安装的第三篇

本文将主要介绍创建kubeconfig配置文件 她们是kubernetes客户端与API Server 认证与鉴权的保证

### 客户端认证配置

本节将会创建用于 kube-proxy kube-controll-manager kube-scheduler 和kubelet 的kubeconfig文件

### kubelet配置文件

为了确保Node Authorizer授权 kubelet配置文件中的客户端证书必须匹配Node名字

Node名字还使用生成证书那一节配置的环境变量

为所有节点创建kubeconfig配置（都在master节点操作）

#### master节点

```
mkdir kubeconfig
cd kubeconfig/
```

```

kubectl config set-cluster kubernetes-training \
  --certificate-authority=ca.pem \
  --embed-certs=true \
  --server=https://${MASTER_IP}:6443 \
  --kubeconfig=master.kubeconfig

kubectl config set-credentials system:node:master \
  --client-certificate=master.pem \
  --client-key=master-key.pem \
  --embed-certs=true \
  --kubeconfig=master.kubeconfig

kubectl config set-context default \
  --cluster=kubernetes-training \
  --user=system:node:master \
  --kubeconfig=master.kubeconfig

kubectl config use-context default --kubeconfig=master.kubeconfig
```

输出文件

```
ls master*
```

```
master.kubeconfig
```



node1节点的配置文件

```

kubectl config set-cluster kubernetes-training \
  --certificate-authority=ca.pem \
  --embed-certs=true \
  --server=https://${MASTER_IP}:6443 \
  --kubeconfig=node1.kubeconfig

kubectl config set-credentials system:node:node1 \
  --client-certificate=node1.pem \
  --client-key=node1-key.pem \
  --embed-certs=true \
  --kubeconfig=node1.kubeconfig

kubectl config set-context default \
  --cluster=kubernetes-training \
  --user=system:node:node1 \
  --kubeconfig=node1.kubeconfig

kubectl config use-context default --kubeconfig=node1.kubeconfig
```

输出文件

```
ls node1*
```

```
node1.kubeconfig
```

node2节点配置文件

```

kubectl config set-cluster kubernetes-training \
  --certificate-authority=ca.pem \
  --embed-certs=true \
  --server=https://${MASTER_IP}:6443 \
  --kubeconfig=node2.kubeconfig

kubectl config set-credentials system:node:node2 \
  --client-certificate=node2.pem \
  --client-key=node2-key.pem \
  --embed-certs=true \
  --kubeconfig=node2.kubeconfig

kubectl config set-context default \
  --cluster=kubernetes-training \
  --user=system:node:node2 \
  --kubeconfig=node2.kubeconfig

kubectl config use-context default --kubeconfig=node2.kubeconfig
```

输出文件

```
ls node2*
```

```
node2.kubeconfig
```

### kube-proxy配置文件

为kube-proxy服务生成kubeconfig配置文件

```


kubectl config set-cluster kubernetes-training \
  --certificate-authority=ca.pem \
  --embed-certs=true \
  --server=https://${MASTER_IP}:6443 \
  --kubeconfig=kube-proxy.kubeconfig

kubectl config set-credentials system:kube-proxy \
  --client-certificate=kube-proxy.pem \
  --client-key=kube-proxy-key.pem \
  --embed-certs=true \
  --kubeconfig=kube-proxy.kubeconfig

kubectl config set-context default \
  --cluster=kubernetes-training \
  --user=system:kube-proxy \
  --kubeconfig=kube-proxy.kubeconfig

kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig
```

输出文件

```
 ls kube-proxy*
```

```
kube-proxy.kubeconfig
```

### kube-controller-manager配置文件

```

kubectl config set-cluster kubernetes-training \
  --certificate-authority=ca.pem \
  --embed-certs=true \
  --server=https://127.0.0.1:6443 \
  --kubeconfig=kube-controller-manager.kubeconfig

kubectl config set-credentials system:kube-controller-manager \
  --client-certificate=kube-controller-manager.pem \
  --client-key=kube-controller-manager-key.pem \
  --embed-certs=true \
  --kubeconfig=kube-controller-manager.kubeconfig

kubectl config set-context default \
  --cluster=kubernetes-training \
  --user=system:kube-controller-manager \
  --kubeconfig=kube-controller-manager.kubeconfig

kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig
```

输出文件

```
ls kube-con*
```

```
kube-controller-manager.kubeconfig
```

### kube-scheduler配置文件

```


kubectl config set-cluster kubernetes-training \
  --certificate-authority=ca.pem \
  --embed-certs=true \
  --server=https://127.0.0.1:6443 \
  --kubeconfig=kube-scheduler.kubeconfig

kubectl config set-credentials system:kube-scheduler \
  --client-certificate=kube-scheduler.pem \
  --client-key=kube-scheduler-key.pem \
  --embed-certs=true \
  --kubeconfig=kube-scheduler.kubeconfig

kubectl config set-context default \
  --cluster=kubernetes-training \
  --user=system:kube-scheduler \
  --kubeconfig=kube-scheduler.kubeconfig

kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig

```

输出文件

```
ls kube-sch*
```

```
kube-scheduler.kubeconfig
```

Admin配置文件

```


kubectl config set-cluster kubernetes-training \
  --certificate-authority=ca.pem \
  --embed-certs=true \
  --server=https://127.0.0.1:6443 \
  --kubeconfig=admin.kubeconfig

kubectl config set-credentials admin \
  --client-certificate=admin.pem \
  --client-key=admin-key.pem \
  --embed-certs=true \
  --kubeconfig=admin.kubeconfig

kubectl config set-context default \
  --cluster=kubernetes-training \
  --user=admin \
  --kubeconfig=admin.kubeconfig

kubectl config use-context default --kubeconfig=admin.kubeconfig

```

输出文件

```
ls ad*
```

```
admin.kubeconfig
```

## 分发配置文件

将 kubelet 与 kube-proxy kubeconfig 配置文件复制到每个 worker 节点上：

```
scp node1.kubeconfig kube-proxy.kubeconfig node1:~/
scp node2.kubeconfig kube-proxy.kubeconfig node2:~/
```


将 admin、kube-controller-manager 与 kube-scheduler kubeconfig 配置文件复制到每个控制节点上：

```
scp admin.kubeconfig master.kubeconfig kube-proxy.kubeconfig kube-controller-manager.kubeconfig kube-scheduler.kubeconfig master:~/
```

